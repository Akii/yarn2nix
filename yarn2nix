#!/usr/bin/env ruby

input_file = ARGV.shift
output_file = ARGV.shift

if input_file.nil? || output_file.nil?
  $stderr.puts "No input and/or output file provided!"
  puts "Expected usage: #{$0} <some yarn.lock file> <yarn-dep-output.nix>"
end

FIRST_TWO_LINES = [
  "# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.",
  "# yarn lockfile v1"
]

lines = File.read(input_file).split("\n")
first_two = lines.shift 2

if first_two != FIRST_TWO_LINES
  $stderr.puts "First two lines of the yarn lock file do not match!"
  $stderr.puts "Only lockfile v1 is supported"
end

REGEX = /^  resolved "(?<url>https?:\/\/[^\/]+\/(?<name>.*)\/-\/(?<tgz>.*)#(?<sha1>.*))"$/
dependencies = lines.select { |line| line.start_with? "  resolved" }.map do |line|
  match = REGEX.match(line)
  name = match["name"]
  url  = match["url"]
  tgz  = match["tgz"]
  sha1 = match["sha1"]

  { name: name, url: url, tgz: tgz, sha1: sha1 }
end

File.open(output_file,"w") do |output|
  output.puts '['

  dep_key_names = []
  dependencies.each do |dep|
    name = "npm-" + dep[:tgz].sub(/\.tgz$/,"") + "-" + dep[:sha1]
    output.puts ' {'
    output.puts '   name = "%s";' % name
    output.puts '   url = "%s";' % dep[:url]
    output.puts '   sha1 = "%s";' % dep[:sha1]
    output.puts ' }'
  end
  output.puts ']'
end
